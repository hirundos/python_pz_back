# Pizza Backend API 설계도

## 프로젝트 개요
- **프로젝트명**: pizza_back
- **프레임워크**: Django 5.2.5 + Django REST Framework
- **데이터베이스**: PostgreSQL
- **인증**: JWT (JSON Web Token)
- **CORS**: 모든 오리진 허용

## 주요 기능
1. **사용자 인증 및 관리**
2. **피자 메뉴 관리**
3. **주문 처리 및 관리**

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    Client (Frontend)                        │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTP/HTTPS
                      │ JWT Token
┌─────────────────────▼───────────────────────────────────────┐
│                 Django Backend                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                URL Router                                ││
│  │  /api/login/     /api/menu/     /api/order/            ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                Middleware Stack                         ││
│  │  CORS → Security → Session → Auth → Messages           ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                Application Layer                         ││
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                 ││
│  │  │  Login  │  │  Menu   │  │  Order  │                 ││
│  │  │   App   │  │   App   │  │   App   │                 ││
│  │  └─────────┘  └─────────┘  └─────────┘                 ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                Database Layer                           ││
│  │              PostgreSQL Database                        ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

## 데이터베이스 설계

### 1. Member 테이블 (사용자)
```sql
CREATE TABLE member (
    member_id VARCHAR(100) PRIMARY KEY,
    member_pwd VARCHAR(100) NOT NULL,
    member_nm VARCHAR(100) NOT NULL
);
```

### 2. PizzaType 테이블 (피자 종류)
```sql
CREATE TABLE pizza_types (
    pizza_type_id VARCHAR(50) PRIMARY KEY,
    pizza_nm VARCHAR(50) NOT NULL,
    pizza_categ VARCHAR(50) NOT NULL,
    pizza_img_url VARCHAR(100) NOT NULL
);
```

### 3. Pizza 테이블 (피자 상품)
```sql
CREATE TABLE pizza (
    pizza_id VARCHAR(50) PRIMARY KEY,
    pizza_type_id VARCHAR(50) REFERENCES pizza_types(pizza_type_id),
    size VARCHAR(50) NOT NULL,
    price FLOAT NOT NULL
);
```

### 4. Branch 테이블 (지점)
```sql
CREATE TABLE branch (
    bran_id VARCHAR(100) PRIMARY KEY,
    bran_nm VARCHAR(100) NOT NULL
);
```

### 5. Order 테이블 (주문)
```sql
CREATE TABLE orders (
    order_id VARCHAR(50) PRIMARY KEY,
    member_id VARCHAR(50) NOT NULL,
    bran_id VARCHAR(100) REFERENCES branch(bran_id),
    date VARCHAR(50) NOT NULL,
    time VARCHAR(50) NOT NULL
);
```

### 6. OrderDetail 테이블 (주문 상세)
```sql
CREATE TABLE order_detail (
    order_detail_id INTEGER PRIMARY KEY,
    order_id VARCHAR(50) REFERENCES orders(order_id),
    pizza_id VARCHAR(50) REFERENCES pizza(pizza_id),
    quantity INTEGER NOT NULL
);
```

## API 엔드포인트

### 1. Login App (`/api/login/`)
| Method | Endpoint | 기능 | 인증 필요 |
|--------|----------|------|-----------|
| POST | `/login/` | 로그인 (JWT 토큰 발급) | ❌ |
| GET | `/login/logout/` | 로그아웃 | ❌ |
| POST | `/login/register/` | 회원가입 | ❌ |

### 2. Menu App (`/api/menu/`)
| Method | Endpoint | 기능 | 인증 필요 |
|--------|----------|------|-----------|
| GET | `/menu/` | 피자 목록 조회 | ❌ |
| GET | `/menu/types/` | 피자 종류 조회 | ❌ |
| POST | `/menu/get_pizza_id/` | 피자 ID 조회 | ❌ |

### 3. Order App (`/api/order/`)
| Method | Endpoint | 기능 | 인증 필요 |
|--------|----------|------|-----------|
| GET | `/order/myorder/` | 내 주문 목록 조회 | ✅ |
| POST | `/order/` | 새 주문 생성 | ✅ |
| GET | `/order/branch/` | 지점 목록 조회 | ❌ |

## 인증 시스템

### JWT 토큰 구조
```json
{
  "member_id": "사용자ID",
  "exp": "만료시간",
  "iat": "발급시간"
}
```

### 인증 플로우
1. 클라이언트가 로그인 요청 (`POST /api/login/`)
2. 서버가 유효한 사용자인지 확인
3. JWT 토큰 생성 및 반환
4. 클라이언트가 이후 요청에 `Authorization: Bearer <token>` 헤더 포함
5. 서버가 토큰 검증 후 요청 처리

## 주요 비즈니스 로직

### 1. 주문 처리 플로우
1. 사용자 인증 확인
2. 주문 데이터 유효성 검사
3. 피자 ID 조회 (외부 API 호출)
4. 주문 및 주문 상세 정보 생성
5. 트랜잭션으로 데이터 일관성 보장

### 2. 피자 ID 조회 로직
- 피자 이름과 사이즈로 피자 타입 ID 조회
- 피자 타입 ID와 사이즈로 최종 피자 ID 조회
- 외부 API를 통한 실시간 피자 정보 확인

## 보안 고려사항

### 현재 구현된 보안 기능
- JWT 기반 인증
- CORS 설정
- CSRF 보호 (일부 엔드포인트에서 제외)

### 개선 필요 사항
- 비밀번호 해싱 (현재 평문 저장)
- 입력 데이터 검증 강화
- SQL 인젝션 방지
- Rate Limiting 구현

## 기술 스택

### Backend
- Django 5.2.5
- Django REST Framework
- PostgreSQL
- JWT (PyJWT)
- CORS Headers

### 개발 환경
- Python Virtual Environment
- Django Admin Interface
- SQLite (개발용, 실제 운영은 PostgreSQL)

## 배포 및 운영

### 환경 설정
- `DEBUG = True` (개발 모드)
- `ALLOWED_HOSTS = []` (모든 호스트 허용)
- PostgreSQL 연결 설정 완료
- CORS 모든 오리진 허용

### API 기본 URL
- 개발 환경: `http://localhost:8000/api`

## 테스트 계획 (MSA 환경)

### 테스트 전략
- **단위 테스트**: 각 서비스의 모델, 뷰, 서비스 로직별 독립적 테스트
- **통합 테스트**: 각 서비스 내부 API 엔드포인트 전체 플로우 테스트
- **서비스 간 테스트**: MSA 환경에서 서비스들이 서로 호출하는 시나리오 테스트
- **계약 테스트**: 서비스 간 API 계약 준수 여부 테스트
- **성능 테스트**: 각 서비스의 응답 시간 및 처리량 테스트
- **컨테이너 테스트**: Docker 컨테이너 환경에서의 테스트

### 테스트 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    Test Environment                          │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              Test Orchestration                         ││
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                 ││
│  │  │  Login  │  │  Menu   │  │  Order  │                 ││
│  │  │ Service │  │ Service │  │ Service │                 ││
│  │  │ Tests   │  │ Tests   │  │ Tests   │                 ││
│  │  └─────────┘  └─────────┘  └─────────┘                 ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │              Shared Test Components                     ││
│  │  • Test Data Factory                                    ││
│  │  • Test Utilities                                       ││
│  │  • Mock Services                                        ││
│  │  • API Client                                           ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 테스트 범위

#### 1. Login Service 테스트 (`/services/login/`)
- **모델 테스트**
  - Member 모델 생성/수정/삭제
  - 데이터 유효성 검증
  - 고유 제약조건 테스트

- **API 엔드포인트 테스트**
  - `POST /login/` - 사용자 로그인
  - `POST /login/register/` - 회원가입
  - `GET /login/logout/` - 로그아웃

- **인증 서비스 테스트**
  - JWT 토큰 생성 및 검증
  - 토큰 만료 처리
  - 비밀번호 해싱 검증
  - 인증 미들웨어 테스트

#### 2. Menu Service 테스트 (`/services/menu/`)
- **모델 테스트**
  - PizzaType 모델 테스트
  - Pizza 모델 테스트
  - 외래키 관계 및 데이터 무결성

- **API 엔드포인트 테스트**
  - `GET /menu/` - 피자 목록 조회
  - `GET /menu/types/` - 피자 타입 조회
  - `POST /menu/get_pizza_id/` - 피자 ID 조회

- **캐시 서비스 테스트**
  - 메뉴 데이터 캐싱
  - 캐시 무효화 로직

#### 3. Order Service 테스트 (`/services/order/`)
- **모델 테스트**
  - Branch 모델 테스트
  - Order 모델 테스트
  - OrderDetail 모델 테스트
  - 복잡한 관계형 데이터 테스트

- **API 엔드포인트 테스트**
  - `POST /order/` - 주문 생성
  - `GET /order/myorder/` - 주문 내역 조회
  - `GET /order/branch/` - 지점 목록 조회

- **트랜잭션 테스트**
  - 주문 생성 시 데이터 일관성
  - 롤백 시나리오 테스트

### 서비스 간 통합 테스트

#### 1. 주문 생성 통합 테스트
```
사용자 로그인 → 피자 메뉴 조회 → 주문 생성 → 주문 내역 확인
     ↓              ↓             ↓            ↓
  Login Service  Menu Service  Order Service  (검증)
```

- **시나리오**: 사용자 로그인 → 피자 조회 → 주문 생성 → 주문 완료까지 전체 플로우
- **테스트 항목**:
  - 서비스 간 토큰 전달
  - 데이터 일관성 검증
  - 에러 상황에서의 롤백 처리
  - 타임아웃 처리

#### 2. 사용자 경험 플로우 테스트
- **회원가입 → 로그인 → 메뉴 조회 → 주문 → 주문확인**
- **에러 시나리오**: 서비스 중단 시 graceful degradation
- **성능 테스트**: 각 서비스 응답 시간 측정

### 테스트 인프라

#### 1. 테스트 데이터베이스
```yaml
# docker-compose.test.yml
version: '3.8'
services:
  test-db:
    image: postgres:13
    environment:
      POSTGRES_DB: pizza_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_pass
    ports:
      - "5432:5432"
    volumes:
      - test_db_data:/var/lib/postgresql/data
```

#### 2. 테스트 데이터 팩토리
- 각 서비스별 테스트 데이터 생성 팩토리
- 더미 데이터와 리얼한 테스트 데이터 구분
- 데이터베이스 초기화 및 정리 유틸리티

#### 3. API 클라이언트
- 서비스 간 HTTP 호출을 위한 공통 클라이언트
- 타임아웃, 재시도 로직 포함
- 응답 검증 헬퍼

### 테스트 실행 전략

#### 1. 독립적 서비스 테스트
```bash
# Login Service 테스트
cd services/login
python manage.py test authapp.tests

# Menu Service 테스트
cd services/menu
python manage.py test catalog.tests

# Order Service 테스트
cd services/order
python manage.py test orders.tests
```

#### 2. 통합 테스트 실행
```bash
# 모든 서비스 동시에 시작하여 통합 테스트
docker-compose -f docker-compose.test.yml up -d

# 통합 테스트 스크립트 실행
./scripts/run_integration_tests.sh
```

#### 3. CI/CD 파이프라인 테스트
```yaml
# .github/workflows/test.yml
name: MSA Tests
on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run Login Service Tests
        run: |
          cd services/login
          python manage.py test

  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        run: ./scripts/setup_test_env.sh
        run: ./scripts/run_integration_tests.sh
```

### 테스트 커버리지 목표

#### 1. 코드 커버리지
- **단위 테스트**: 85% 이상
- **통합 테스트**: 70% 이상
- **전체 커버리지**: 80% 이상

#### 2. 테스트 타입별 목표
- **API 테스트**: 모든 엔드포인트 100% 커버
- **모델 테스트**: 모든 모델 관계 100% 커버
- **에러 핸들링**: 모든 예외 시나리오 커버

### 테스트 모니터링 및 리포팅

#### 1. 테스트 결과 대시보드
- 각 서비스별 테스트 성공/실패 현황
- 통합 테스트 결과 추적
- 커버리지 트렌드 분석

#### 2. 품질 게이트
- 코드 커버리지 임계값 설정
- 통합 테스트 성공 필수
- 성능 테스트 통과 기준

### 테스트 데이터 관리

#### 1. 테스트 데이터베이스 설계
```sql
-- 테스트용 스키마
CREATE SCHEMA pizza_test;

-- 테스트 데이터 시딩
INSERT INTO pizza_test.member (member_id, member_pwd, member_nm)
VALUES ('test_user', 'hashed_password', '테스트사용자');
```

#### 2. 데이터베이스 격리
- 각 테스트 실행 시 독립적 데이터베이스 사용
- 테스트 완료 후 데이터베이스 정리
- 테스트 데이터와 실제 데이터 완전 분리

### 성능 테스트 계획

#### 1. 로드 테스트
- 각 서비스별 최대 처리량 측정
- 응답 시간 기준치 설정 (평균 200ms 이내)

#### 2. 스트레스 테스트
- 서비스 장애 시나리오 테스트
- 데이터베이스 연결 풀 한계 테스트

#### 3. 볼륨 테스트
- 대량 데이터 처리 성능 검증
- 메모리 사용량 모니터링

### 테스트 자동화

#### 1. Pre-commit 훅
- 코드 변경 시 자동으로 단위 테스트 실행
- 린팅과 함께 통합

#### 2. 자동화된 테스트 실행
- PR 생성 시 자동으로 통합 테스트 실행
- 메인 브랜치 머지 전 모든 테스트 통과 확인

### 테스트 문서화

#### 1. 테스트 케이스 문서
- 각 테스트의 목적과 시나리오 명확히 기술
- 예상 결과와 실제 결과 비교 방법

#### 2. API 명세서
- OpenAPI/Swagger 기반 API 문서 자동 생성
- 테스트 케이스와 연동

이 MSA 테스트 계획은 서비스의 독립성과 확장성을 보장하면서도 서비스 간 상호작용을 철저히 검증할 수 있도록 설계되었습니다. 각 서비스의 특성에 맞는 테스트 전략을 적용하여 전체 시스템의 품질을 높일 수 있습니다.