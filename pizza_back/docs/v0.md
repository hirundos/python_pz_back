# Pizza Backend API 설계도

## 프로젝트 개요
- **프로젝트명**: pizza_back
- **프레임워크**: Django 5.2.5 + Django REST Framework
- **데이터베이스**: PostgreSQL
- **인증**: JWT (JSON Web Token)
- **CORS**: 모든 오리진 허용

## 주요 기능
1. **사용자 인증 및 관리**
2. **피자 메뉴 관리**
3. **주문 처리 및 관리**

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    Client (Frontend)                        │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTP/HTTPS
                      │ JWT Token
┌─────────────────────▼───────────────────────────────────────┐
│                 Django Backend                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                URL Router                                ││
│  │  /api/login/     /api/menu/     /api/order/            ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                Middleware Stack                         ││
│  │  CORS → Security → Session → Auth → Messages           ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                Application Layer                         ││
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                 ││
│  │  │  Login  │  │  Menu   │  │  Order  │                 ││
│  │  │   App   │  │   App   │  │   App   │                 ││
│  │  └─────────┘  └─────────┘  └─────────┘                 ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                Database Layer                           ││
│  │              PostgreSQL Database                        ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

## 데이터베이스 설계

### 1. Member 테이블 (사용자)
```sql
CREATE TABLE member (
    member_id VARCHAR(100) PRIMARY KEY,
    member_pwd VARCHAR(100) NOT NULL,
    member_nm VARCHAR(100) NOT NULL
);
```

### 2. PizzaType 테이블 (피자 종류)
```sql
CREATE TABLE pizza_types (
    pizza_type_id VARCHAR(50) PRIMARY KEY,
    pizza_nm VARCHAR(50) NOT NULL,
    pizza_categ VARCHAR(50) NOT NULL,
    pizza_img_url VARCHAR(100) NOT NULL
);
```

### 3. Pizza 테이블 (피자 상품)
```sql
CREATE TABLE pizza (
    pizza_id VARCHAR(50) PRIMARY KEY,
    pizza_type_id VARCHAR(50) REFERENCES pizza_types(pizza_type_id),
    size VARCHAR(50) NOT NULL,
    price FLOAT NOT NULL
);
```

### 4. Branch 테이블 (지점)
```sql
CREATE TABLE branch (
    bran_id VARCHAR(100) PRIMARY KEY,
    bran_nm VARCHAR(100) NOT NULL
);
```

### 5. Order 테이블 (주문)
```sql
CREATE TABLE orders (
    order_id VARCHAR(50) PRIMARY KEY,
    member_id VARCHAR(50) NOT NULL,
    bran_id VARCHAR(100) REFERENCES branch(bran_id),
    date VARCHAR(50) NOT NULL,
    time VARCHAR(50) NOT NULL
);
```

### 6. OrderDetail 테이블 (주문 상세)
```sql
CREATE TABLE order_detail (
    order_detail_id INTEGER PRIMARY KEY,
    order_id VARCHAR(50) REFERENCES orders(order_id),
    pizza_id VARCHAR(50) REFERENCES pizza(pizza_id),
    quantity INTEGER NOT NULL
);
```

## API 엔드포인트

### 1. Login App (`/api/login/`)
| Method | Endpoint | 기능 | 인증 필요 |
|--------|----------|------|-----------|
| POST | `/login/` | 로그인 (JWT 토큰 발급) | ❌ |
| GET | `/login/logout/` | 로그아웃 | ❌ |
| POST | `/login/register/` | 회원가입 | ❌ |

### 2. Menu App (`/api/menu/`)
| Method | Endpoint | 기능 | 인증 필요 |
|--------|----------|------|-----------|
| GET | `/menu/` | 피자 목록 조회 | ❌ |
| GET | `/menu/types/` | 피자 종류 조회 | ❌ |
| POST | `/menu/get_pizza_id/` | 피자 ID 조회 | ❌ |

### 3. Order App (`/api/order/`)
| Method | Endpoint | 기능 | 인증 필요 |
|--------|----------|------|-----------|
| GET | `/order/myorder/` | 내 주문 목록 조회 | ✅ |
| POST | `/order/` | 새 주문 생성 | ✅ |
| GET | `/order/branch/` | 지점 목록 조회 | ❌ |

## 인증 시스템

### JWT 토큰 구조
```json
{
  "member_id": "사용자ID",
  "exp": "만료시간",
  "iat": "발급시간"
}
```

### 인증 플로우
1. 클라이언트가 로그인 요청 (`POST /api/login/`)
2. 서버가 유효한 사용자인지 확인
3. JWT 토큰 생성 및 반환
4. 클라이언트가 이후 요청에 `Authorization: Bearer <token>` 헤더 포함
5. 서버가 토큰 검증 후 요청 처리

## 주요 비즈니스 로직

### 1. 주문 처리 플로우
1. 사용자 인증 확인
2. 주문 데이터 유효성 검사
3. 피자 ID 조회 (외부 API 호출)
4. 주문 및 주문 상세 정보 생성
5. 트랜잭션으로 데이터 일관성 보장

### 2. 피자 ID 조회 로직
- 피자 이름과 사이즈로 피자 타입 ID 조회
- 피자 타입 ID와 사이즈로 최종 피자 ID 조회
- 외부 API를 통한 실시간 피자 정보 확인

## 보안 고려사항

### 현재 구현된 보안 기능
- JWT 기반 인증
- CORS 설정
- CSRF 보호 (일부 엔드포인트에서 제외)

### 개선 필요 사항
- 비밀번호 해싱 (현재 평문 저장)
- 입력 데이터 검증 강화
- SQL 인젝션 방지
- Rate Limiting 구현

## 기술 스택

### Backend
- Django 5.2.5
- Django REST Framework
- PostgreSQL
- JWT (PyJWT)
- CORS Headers

### 개발 환경
- Python Virtual Environment
- Django Admin Interface
- SQLite (개발용, 실제 운영은 PostgreSQL)

## 배포 및 운영

### 환경 설정
- `DEBUG = True` (개발 모드)
- `ALLOWED_HOSTS = []` (모든 호스트 허용)
- PostgreSQL 연결 설정 완료
- CORS 모든 오리진 허용

### API 기본 URL
- 개발 환경: `http://localhost:8000/api`

## 테스트 계획

### 테스트 전략
- **단위 테스트**: 각 모델, 뷰, 유틸리티 함수별 테스트
- **통합 테스트**: API 엔드포인트 전체 플로우 테스트
- **인증 테스트**: JWT 토큰 기반 인증 시스템 테스트
- **데이터베이스 테스트**: 모델 관계 및 데이터 무결성 테스트

### 테스트 범위

#### 1. Login App 테스트
- **회원가입 테스트**
  - 정상적인 회원가입
  - 중복 ID 처리
  - 필수 필드 누락 처리
  - 잘못된 JSON 형식 처리

- **로그인 테스트**
  - 정상적인 로그인
  - 잘못된 자격증명 처리
  - JWT 토큰 생성 및 검증
  - 토큰 만료 처리

- **로그아웃 테스트**
  - 로그아웃 응답 확인

#### 2. Menu App 테스트
- **피자 목록 조회 테스트**
  - 전체 피자 목록 반환
  - 빈 데이터베이스 처리

- **피자 종류 조회 테스트**
  - 피자 타입 목록 반환
  - 이미지 URL 포함 확인

- **피자 ID 조회 테스트**
  - 정상적인 피자 ID 조회
  - 존재하지 않는 피자 처리
  - 잘못된 사이즈 처리

#### 3. Order App 테스트
- **주문 생성 테스트**
  - 정상적인 주문 생성
  - 인증되지 않은 사용자 처리
  - 잘못된 주문 데이터 처리
  - 트랜잭션 롤백 테스트

- **주문 내역 조회 테스트**
  - 사용자별 주문 내역 조회
  - 빈 주문 내역 처리
  - 인증되지 않은 접근 처리

- **지점 조회 테스트**
  - 전체 지점 목록 반환
  - 빈 지점 데이터 처리

#### 4. 인증 시스템 테스트
- **JWT 토큰 테스트**
  - 토큰 생성 및 검증
  - 토큰 만료 처리
  - 잘못된 토큰 처리
  - Authorization 헤더 누락 처리

#### 5. 데이터베이스 테스트
- **모델 관계 테스트**
  - 외래키 관계 확인
  - CASCADE 삭제 동작
  - 데이터 무결성 확인

### 테스트 데이터
- 테스트용 사용자 계정
- 샘플 피자 데이터
- 샘플 지점 데이터
- 테스트용 주문 데이터

### 테스트 실행 방법
```bash
# 전체 테스트 실행
python manage.py test

# 특정 앱 테스트 실행
python manage.py test pizza_back.login
python manage.py test pizza_back.menu
python manage.py test pizza_back.order

# 특정 테스트 클래스 실행
python manage.py test pizza_back.login.tests.LoginTestCase

# 커버리지 리포트 생성
coverage run --source='.' manage.py test
coverage report
coverage html
```